<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>Document</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
        }

        .blog-form {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 400px;
            margin: 20px auto;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #3498db;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #2980b9;
        }

        #display {
            margin-top: 20px;
        }

        #inner {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }

        #im {
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <h1>hello <span id="disp"></span> welome to ur bolgspace_app </h1>
    <div class="div">
        <input type="text" name="" id="na_me">
        <input type="file" onchange="activate()" name="" id="fileInput">
        <img src="" alt="" id="img">
        <textarea name="" id="note" cols="20" rows="2" placeholder="write a comment"></textarea>
    </div>
    <button onclick="post()">Post</button>
    <div id="display">

    </div>
    <button onclick="log_out()">logout</button>
</body>

</html>
<script>
    let user
    fetch(`http://localhost:1244/loggedIn_user`).then((res) => res.json()).then((data) => {
        console.log(data)
        // let validated = JSON.parse(localStorage.getItem("validated_user")) || false
        // console.log(validated)
        user = data
        if (user.length > 0) {
            document.getElementById('disp').innerHTML = ` ${user[0].Lastname}`
        } else {
            alert('unknown user cant be here abeg go login')
            window.location.href = 'login.html'
        }
    })

    function log_out() {
        fetch(`http://localhost:1244/loggedIn_user/${user[0].id}`, {
            headers: {
                "Content-Type": "application/json"
            },
            method: "DELETE"
        }).then((res) => res.json())
            .then((data) => {
                console.log(data);
                alert('logged out successfully')
                window.location.href = 'login.html'
            }).catch((err) => {
                console.log(err);
            })
        // localStorage.removeItem('validated_user')
    }

    let na_me = document.getElementById('na_me')
    let note = document.getElementById('note')
    let img = document.getElementById('img')
    let display = document.getElementById('display')
    let date = new Date();
    let imgURL;
    let allPost;
    function post() {
        let obj = {
            Author: user[0].Lastname,
            Image: imgURL,
            coment: note.value,
            isLiked: false,
            time_posted: `${date.getHours()} : ${date.getMinutes()} ${date.getHours() > 12 ? "PM" : "AM"}`
        }
        fetch("http://localhost:1244/posts", {
            headers: {
                "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(obj)
        }).then((res)=>res.json())
        .then((data)=>{
            console.log(data);
            alert("Post Created Successfully")
            img.src = ""
            note.value = ""
            dispPosts()
        })
        // display.innerHTML = ''
        // array.forEach(({ obj }, i) => {
        //     display.innerHTML +=
        //         `
        //
        // `

        // });
    }

    function dispPosts(){

        fetch("http://localhost:1244/posts").then((res)=> res.json())
        .then((data)=>{
            console.log(data);
            allPost = data
            display.innerHTML = ""
            allPost.forEach(element => {
                display.innerHTML += `
                <div  id="inner">
                    <h3>Author:${element.Author}</h3>
                    <button style="float: right;" class="btn btn-danger">&times;</button>
                    <br>
                    <div id="innerr"><img id="im" src="${element.Image}" alt="${element.Author}"></div>
                    <br>
                    <br>
                    <br>
                    <p>Comment : ${element.coment}</p>
                    <button class="btn btn-${element.isLiked? "secondary": "info"}" onclick="likePost('${element.id}')">${element.isLiked? "UnLike": "Like"}</button>
                    <button>See more</button>
                </div>
                `
            });
        }).catch((err)=>{
            console.log(err);
        })
    }
    dispPosts()
    function likePost(id){
        let onePost = allPost.find((el)=> el.id == id);
        if(onePost){
            onePost.isLiked = !onePost.isLiked;
            fetch(`http://localhost:1244/posts/${id}`, {
                headers: {
                    "Content-Type": "application/json"
                },
                method: "PATCH",
                body: JSON.stringify(onePost)
            }).then((res)=> res.json())
            .then((data)=>{
                console.log(data);
                alert("Post Updated")
                dispPosts()
            }).catch((err)=>{
                console.log(err);
            })
        }else{
            alert("Post not found")
        }
    }
    function activate() {
        let filemi_onchange = document.getElementById('fileInput');
        let imgtag = document.getElementById("img");
        console.log(filemi_onchange.files);//to get the obj
        let fileReader = new FileReader(); //creating a filereader object
        console.log(fileReader);
        fileReader.addEventListener('load', (el) => {
            let result = el.target.result;
            imgtag.src = result;
            imgURL = result
        })
        if (filemi_onchange) {
            fileReader.readAsDataURL(filemi_onchange.files[0]);
        }
        
    }
</script>